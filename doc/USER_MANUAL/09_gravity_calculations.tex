
\chapter{Computation of static and transient gravity field}

\section{Static gravity field}

SPECFEM can now compute the static (background) gravity field as well as 
its derivatives (i.e., gravity gradiometry)
generated by any given 3D Earth model at the height 
of an observation satellite, for instance GOCE\newline
(see e.g. en.wikipedia.org/wiki/Gravity\_Field\_and\_Steady-State\_Ocean\_Circulation\_Explorer).\newline
That feature is still experimental but should work just fine.\newline


\noindent
To see how it is implemented and to use it, type this in the root directory of the code:
\begin{verbatim}
grep -i GRAVITY_INTEGRALS src/*/*
\end{verbatim}
All main gravity field computations can be found in file \texttt{src/meshfem3d/gravity\_integrals.F90}.
Please make sure you compile the code with double-precision, i.e., use flag \texttt{{-}{-}enable-double-precision} for the
configuration of the package.

\section{Coupled elasto-gravitational (transient) simulations}

Ground deformation modelled in SPECFEM causes motion of 
Earth's density field,which produces perturbations in its 
gravitational field. This perturbation in the gravitational 
field acts as a separate force in the elastodynamics 
equations, which introduces itself drives ground deformation.
 Hence there is implicit coupling between the deformation 
 of the ground and the changing gravity field. SPECFEM3D\_GLOBE  
 typically models gravity using \textit{Cowling's Approximation}
 in which only the background gravity field is incorporated, 
 while the transient perturbation in the gravity field is 
 ignored. In some cases, however, you may wish to include the 
 full elastogravitational coupling. This section describes
 how to incorporate this coupling into your simulation. 
 Those using this feature should cite \cite{GhEaTr23}. 


 \subsection{Should I use full gravitational coupling in my simulation?}
 
 Simulations incorporating full elastogravitational are \textbf{substantially} slower than when using \textit{Cowling's Approximation}. 
 It is therefore recommended that you only use full gravitational coupling if you really need it. There are two main cases
 for which you may be interested in switching this feature on: 
 
 \begin{enumerate}

 \item \textit{ Long-period wavefields}

 The effect of gravity perturbations on the elastic wavefield are negligible at periods below ~ 50-100 seconds; see, for 
 example, \cite{GhEaTr23} Fig. 13 for a demonstration of the gravitational effect on a wavefield filtered to various 
 frequencies. Therefore you can ignore these effects unless you are interested in long-period seismology.
 
 \item \textit{ Deformation-induced gravity modelling}

 Evidently, if you are interested in simulating the gravitational signals associated with ground motion then it is critical
 to include self-gravitation! 
 
 \item \textit{ Accurate modelling of an accelerometer} 

 As disussed in \cite{DaTr98}, Ch. 4, an accelerometer does not simply measure the ground acceleration. The measured signal 
 is a combination of the ground acceleration, perturbation in gravitational acceleration, Coriolis effects, and a free-air effect. 
 Hence, for accurate modelling of acceleration measured at a receiver, one may wish to compute these other terms. These 
 effects are, for example, very important in the computation of Prompt Elastogravitational Signals (PEGS). Each of these aforementioned 
 effects measured by an accelerometer can be outputted from SPECFEM3D\_GLOBE.

\end{enumerate} 



\subsection{Requirements \& configuration for the solver}
 
Incorporating poisson's equation requires solution to a global matrix of the form $\mathbf{A}\mathbf{x} = \mathbf{b}$. 
For this two options are available: an in-built solver, as well as a solver built using the \href{http://petsc.org/release/}{PETSC} toolkit. 
Although a built-in solver is implemeted, we recommend using the PETSC solver as it has been benchmarked. As a result, 
you will require a local version of PETSC to be installed, which is not shipped with the main SPECFEM3D\_GLOBE package 


\subsubsection{Installing PETSC}
 
 PETSC may be installed using a variety of methods depending on your hardware and software. It is recommended that you follow
 the \href{https://petsc.org/release/install/}{installation guidelines} on their website, but a few tips are listed below: 
 
 \begin{itemize}
     \item PETSC can be built without a fortran compiler for use in c++. Remember to provide a fortran compiler using \texttt{--with-fc} 
     \item If you are using OpenMPI, you will need to explicitly add the OpenMPI library to your path before configuring. For example using, 
     \begin{verbatim}
$LD_LIBRARY_PATH=/path/to/OpenMPI/lib/:$LD_LIBRARY_PATH
     \end{verbatim}
     \item We recommend installing into a separate directory from the source directory by using the \texttt{--prefix} flag
 \end{itemize}


 An example configuration of PETSC for SPECFEM can be found on a \href{here}{https://github.com/williameaton/SpecfemMagic} 
 on a fork of the \href{SpecfemMagic}{https://github.com/lsawade/SpecfemMagic} scripts originally written by Lucas Sawade. 
 
 
 \subsubsection{Compiling SPECFEM3D\_GLOBE with PETSC}
 
 Compiling SPECFEM3D\_GLOBE with PETSC can be done using the \texttt{--with-petsc} flag. You will also need to include the 
 path to the PETSC \texttt{include} and \text{lib} directories, as well as add the PETSC library path (PETSC\_LIB) to your
 dynamic link library path (LD\_LIBRARY\_PATH). For example 
 \begin{verbatim}
     # define the directory for petsc install 
     $PETSC_DIR=/path/to/petsc_install_directory
 
     # petsc library directory
     $PETSC_LIB=$PETSC_DIR/lib
 
     # petsc include library 
     $PETSC_INC=$PETSC_DIR/include
 
     # add library to LD library paths 
     export LD_LIBRARY_PATH=$PETSC_LIB/:$LD_LIBRARY_PATH
 
     # compile specfem with PETSC: 
     ./configure CC=$CC CXX=$CXX FC=$FC MPIFC=$MPIFC --with-petsc \ 
                 PETSC_INC=$PETSC_INC PETSC_LIB=$PETSC_LIB
 \end{verbatim}
 
 
 \subsection{Running the solver}
 Only two changes are required to run with full gravity. 
 \begin{enumerate}
   \item In the \texttt{Par\_file} both the flags \texttt{GRAVITY} and \texttt{FULL\_GRAVITY} must be set to \texttt{.true.}.   
   \item Set \texttt{POISSON\_SOLVER} to 0 (in-built solver) or 1 (PETSC solver). PETSC is recommended. 
 \end{enumerate}    
 
 
 \subsection{Outputs}
 In addition to the normal displacement time-series for a station, a number of other time-series will be written to 
 \texttt{OUTPUT\_FILES}: 
 
 \begin{itemize}
     \item \texttt{net.sta.MXG.sem.ascii} - Gravitational potential 
     \item \texttt{net.sta.MXZ.C.PGRAV.sem.ascii} - Z direction gravitational acceleration 
 \end{itemize} 
 
 As discussed above, an idealised vertical accelerometer has four terms: 
 \begin{equation}
     A_v = \mathbf{\hat{\nu}} \cdot \left( \partial_t^2 \mathbf{s} + 2\mathbf{\Omega} \times \partial_t\mathbf{s}  + \nabla\phi \right) + \mathbf{s}\cdot \nabla\nabla\Phi \label{eq:idealised_accelerometer}
 \end{equation}
 for which $\hat{\nu}$ is the direction vector, $\mathbf{s}$ is displacement, ${\Omega}$ is the angular velocity, $\phi$ is the 
 perturbation in gravitational potential and $\Phi$ is the background gravitational potential. The terms related to Coriolis
 and the background potential are then outputted as 
 
 \begin{itemize}
     \item \texttt{net.sta.MXZ.C.CORIO.sem.ascii} - Coriolis term 
     \item \texttt{net.sta.MXZ.C.GRAV.sem.ascii}  - Free air term
 \end{itemize} 